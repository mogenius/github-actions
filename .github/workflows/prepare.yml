name: Prepare Version

on:
  workflow_call:
    inputs:
      default_version:
        description: 'Default version if no input is provided'
        required: false
        default: 'dev'
        type: string
      version_override:
        description: 'Explicit version override (e.g. from workflow_dispatch)'
        required: false
        default: ''
        type: string
      ref:
        description: 'Git ref to checkout'
        required: false
        default: ''
        type: string
      dry_run:
        description: 'Run semantic-release in dry-run mode (no tag/release/changelog)'
        required: false
        default: false
        type: boolean
    outputs:
      commit_hash:
        description: 'Short commit hash'
        value: ${{ jobs.prepare.outputs.commit_hash }}
      git_branch:
        description: 'Git branch name'
        value: ${{ jobs.prepare.outputs.git_branch }}
      build_timestamp:
        description: 'Build timestamp in ISO 8601'
        value: ${{ jobs.prepare.outputs.build_timestamp }}
      version:
        description: 'Resolved version string (semver if released, otherwise default/override)'
        value: ${{ jobs.prepare.outputs.version }}
      is_release:
        description: 'Whether semantic-release created a new release'
        value: ${{ jobs.prepare.outputs.is_release }}
      semver:
        description: 'Semver version without v prefix (e.g. 1.0.0), empty if no release'
        value: ${{ jobs.prepare.outputs.semver }}

jobs:
  prepare:
    # runs-on: arc-runner-set
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      issues: write
      pull-requests: write
    outputs:
      commit_hash: ${{ steps.version.outputs.commit_hash }}
      git_branch: ${{ steps.version.outputs.git_branch }}
      build_timestamp: ${{ steps.version.outputs.build_timestamp }}
      version: ${{ steps.version.outputs.version }}
      is_release: ${{ steps.version.outputs.is_release }}
      semver: ${{ steps.version.outputs.semver }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          # ref: ${{ inputs.ref || github.ref }}
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        with:
          dry_run: ${{ inputs.dry_run }}
          extra_plugins: |
            @semantic-release/changelog
            @semantic-release/git
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version info
        id: version
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          # GIT_BRANCH=${GITHUB_REF_NAME}
          GIT_BRANCH=main
          BUILD_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Check if semantic-release published a new version
          NEW_RELEASE="${{ steps.semantic.outputs.new_release_published }}"
          SEMVER="v${{ steps.semantic.outputs.new_release_version }}"

          if [ "${NEW_RELEASE}" == "true" ]; then
            IS_RELEASE="true"
          else
            IS_RELEASE="false"
            SEMVER=""
          fi

          # Priority: version_override > semantic-release version > default_version
          if [ -n "${{ inputs.version_override }}" ]; then
            VERSION="${{ inputs.version_override }}"
          elif [ "${IS_RELEASE}" == "true" ]; then
            VERSION="${SEMVER}"
          else
            VERSION="${{ inputs.default_version }}"
          fi

          echo "commit_hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "git_branch=${GIT_BRANCH}" >> $GITHUB_OUTPUT
          echo "build_timestamp=${BUILD_TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "is_release=${IS_RELEASE}" >> $GITHUB_OUTPUT
          echo "semver=${SEMVER}" >> $GITHUB_OUTPUT

          echo "## Version Info" >> $GITHUB_STEP_SUMMARY
          echo "| Key | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${VERSION} |" >> $GITHUB_STEP_SUMMARY
          echo "| Semver | ${SEMVER:-n/a} |" >> $GITHUB_STEP_SUMMARY
          echo "| New Release | ${IS_RELEASE} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release Type | ${{ steps.semantic.outputs.new_release_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${COMMIT_HASH} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${GIT_BRANCH} |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | ${BUILD_TIMESTAMP} |" >> $GITHUB_STEP_SUMMARY
